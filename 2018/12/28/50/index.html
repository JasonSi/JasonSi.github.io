<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta name="referrer" content="no-referrer"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="Mr. Almost"><title>图片视频瀑布流长列表性能优化实践 | Pujiaxun的空间</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.1.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/7.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
ga('create','UA-113942183-1','auto');ga('send','pageview');</script></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">图片视频瀑布流长列表性能优化实践</h1><a id="logo" href="/.">Pujiaxun的空间</a><p class="description">开始时捱一些苦，栽种绝处的花～</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/history/"><i class="fa fa-book"> 历史</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">图片视频瀑布流长列表性能优化实践</h1><div class="post-meta">Dec 28, 2018<span> | </span><span class="category"><a href="/categories/tech/">技术</a></span></div><a class="disqus-comment-count" href="/2018/12/28/50/#vcomment"><span class="valine-comment-count" data-xid="/2018/12/28/50/"></span><span>条评论</span></a><div class="clear"><div class="toc-article" id="toc"><div class="toc-title">文章目录</div><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#先说需求"><span class="toc-number">1.</span> <span class="toc-text">先说需求</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#遇到性能问题"><span class="toc-number">2.</span> <span class="toc-text">遇到性能问题</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#尝试优化"><span class="toc-number">3.</span> <span class="toc-text">尝试优化</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#性能对比"><span class="toc-number">4.</span> <span class="toc-text">性能对比</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#其他问题"><span class="toc-number">5.</span> <span class="toc-text">其他问题</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#判断Wi-Fi导致卡顿"><span class="toc-number">5.1.</span> <span class="toc-text">判断Wi-Fi导致卡顿</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#静音播放Bug"><span class="toc-number">5.2.</span> <span class="toc-text">静音播放Bug</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#结果不做了"><span class="toc-number">6.</span> <span class="toc-text">结果不做了</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#最后的结局"><span class="toc-number">7.</span> <span class="toc-text">最后的结局</span></a></li></ol></div></div><div class="post-content"><h2 id="先说需求"><a href="#先说需求" class="headerlink" title="先说需求"></a>先说需求</h2><p>需求定义很简单，本来有一个这样的瀑布流页面，滚动加载更多卡片，在此基础上，增加视频支持，也就是说可能是图片也可能是短视频。<strong>视频要求在Wi-Fi时内联静音自动循环播放，不需要其他交互。</strong></p>
<p>是不是非常简单的一句需求，要求也不高。</p>
<p><img src="https://upload-images.jianshu.io/upload_images/703144-3e42d3432b495629.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="瀑布流"></p>
<p>调研了视频<strong>内联播放</strong>的兼容性，问题不大。</p>
<p><strong>静音播放</strong>也就一个muted属性的事情。</p>
<p><strong>自动播放</strong>只需要mounted之后play一下，或者用autoplay属性。</p>
<p><strong>循环播放</strong>就是loop属性啦。</p>
<p><strong>判断Wi-Fi</strong>环境可以通过桥与客户端通信，这个涉及到具体业务，就不细说了，总之，调个API完事。</p>
<p>看起来已经实现了。</p>
<p>开始踩坑。</p>
<h2 id="遇到性能问题"><a href="#遇到性能问题" class="headerlink" title="遇到性能问题"></a>遇到性能问题</h2><p>按照需求，后端会控制视频出现的频率，<strong>至少5个卡片才允许出一个视频</strong>，不然满屏幕视频，效果不好。但这是一个瀑布流，理论上可以滚动加载<strong>成百上千个卡片</strong>，假设每5个卡片放一个视频，效果会如何呢？</p>
<p><img src="https://upload-images.jianshu.io/upload_images/703144-f45213640c7ee847.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="CPU占用情况"></p>
<p>大概也就是这样吧，CPU温度可以上90，占用率300%+（四核八线程），用上那什么iphone-inline-video插件兼容iOS 9的话，可以上600%+。</p>
<p>表现在移动端就是滚都滚不动，即使是iPhone X，滑动起来也是非常无比卡顿。</p>
<h2 id="尝试优化"><a href="#尝试优化" class="headerlink" title="尝试优化"></a>尝试优化</h2><p>现实世界中，用户一个屏幕最多看到几个卡片，基本不可能超过10个，但可能已经加载了上百张卡片，里面的视频都还在自动播放，CPU根本吃不消。</p>
<p>所以优化思路是，<strong>停止掉不需要的视频</strong>。但我的做法靴微激进了点，参考点评APP首页的效果，滚到下面再滚回去图片都是重新加载的，至少看起来是的，也许图片、视频资源都被GC了，而不仅仅是暂停视频。</p>
<p>我的实践是，不在可视区域的图片和视频直接替换成空div，用户滚回来的时候再替换回来。至于图片会不会被GC，交给容器去做。</p>
<p>那么，怎么实现这个效果呢？</p>
<p>一开始我在钻牛角尖的纠结，如何在父组件list中监听滚动，判断屏幕显示了哪些子组件card，并通知某些子组件<strong>你被优化了</strong>。</p>
<p>好像不是很好做，那要不在每个子组件里自己监听一下滚动，判断自己的位置在不在可视区域？感觉性能会很差，毕竟滚动事件本身就会触发很多很多次，还要搞这么多监听器。</p>
<p>后来，我参考了<a href="https://github.com/aFarkas/lazysizes/blob/gh-pages/src/lazysizes-core.js" target="_blank" rel="noopener">lazysizes</a>的实现，它是通过在全局window挂了一个lazyElements列表，在初始化的时候直接querySelectorAll(‘.custom-class-name’)…… 大致思路就是：首先把所有元素加了个特殊的类名，初始化时取出来存在window对象下，然后监听滚动，forEach直接遍历所有元素，根据该元素的位置（是否在可视区域内）来判断是否需要加载。</p>
<p>考虑到我们频繁使用的lazysizes也不过就这样处理的，那我也可以这么做吧。主要实现的代码如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  mounted() &#123;</span><br><span class="line">    <span class="keyword">this</span>.addOptimizeScrollListener();</span><br><span class="line">  &#125;,</span><br><span class="line">  beforeDestroy() &#123;</span><br><span class="line">    <span class="built_in">document</span>.removeEventListener(<span class="string">'scroll'</span>, <span class="keyword">this</span>._optimizeListener, <span class="literal">false</span>);</span><br><span class="line">  &#125;,</span><br><span class="line">  methods: &#123;</span><br><span class="line">    addOptimizeScrollListener() &#123;</span><br><span class="line">      <span class="keyword">const</span> windowHeight = <span class="built_in">window</span>.innerHeight;</span><br><span class="line">      <span class="keyword">const</span> TOLERANCE_HEIGHT = <span class="number">300</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">this</span>._optimizeListener = throttleByRAF(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.$refs.cards) &#123;</span><br><span class="line">          <span class="keyword">this</span>.$refs.cards.forEach(<span class="function"><span class="params">card</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">const</span> rect = card.$el.getBoundingClientRect();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (rect.top &gt; windowHeight + TOLERANCE_HEIGHT || rect.bottom &lt; <span class="number">0</span> - TOLERANCE_HEIGHT) &#123;</span><br><span class="line">              card.isOptimized = <span class="literal">true</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">              card.isOptimized = <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;);</span><br><span class="line">      <span class="built_in">document</span>.addEventListener(<span class="string">'scroll'</span>, <span class="keyword">this</span>._optimizeListener, <span class="literal">false</span>);</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>简单解释一下：在mounted的时候添加滚动监听器。监听器做的事情就是通过<code>$refs</code>拿到cards组件列表，然后类似lazysizes的操作，直接forEach判断是否在视窗内，然后给该card组件实例的<code>isOptimized</code>赋值。这里有一些优化，比如throttleByRAF用来限流执行，TOLERANCE_HEIGHT用来容错，不要这么严格的按照视窗边界来优化，减少用户轻微滚动导致的重复加载。</p>
<p>主要的实现就是这里了，card组件内部只需要根据<code>isOptimized</code>的值来决定渲染图片视频还是空白就可以了。</p>
<p><strong>值得注意的是，必须要获取到原有的图片视频的高度</strong>，否则就会有抖动，甚至瀑布流布局错乱。这里比较特殊的一点是，后端的接口里提供了宽高，可以提前预知高度，所以只需要按照给的高度填充空白即可。</p>
<p><img src="https://upload-images.jianshu.io/upload_images/703144-76de5fb801eacb73.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>
<p>其实也可以把整个card替换成空白占位（当然我这里说的空白不是纯白色，是五颜六色的占位，如果有想法，还可以设计一些占位图，提高视觉效果）。那怎么拿到高度呢？</p>
<p><strong>答案就是<code>window.getComputedStyle</code>!</strong> 在mounted的时候获取一下存起来，被优化的时候用这个高度即可。</p>
<h2 id="性能对比"><a href="#性能对比" class="headerlink" title="性能对比"></a>性能对比</h2><p>首先，来个直观的体验对比，那就是CPU占用没这么夸张了，移动端滚起来也很快乐了，用起来和之前仅有图片时没有太多差别。</p>
<p>在Performance面板能观察到Nodes数量大幅减少，未优化时大约16000+，优化后3000～6000个。</p>
<p>由于之前被误导可能是内存占用过大导致的，所以我详细的对比了一下不同策略的内存使用情况。</p>
<p><img src="https://upload-images.jianshu.io/upload_images/703144-d6c231ae36f53e64.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="内存快照对比"></p>
<p>果然……没什么区别。。。可以看到优化掉整个卡片还是能省一点内存的。粗略看了一下细节，未优化的情况下，其中VueComponents的数量为632，占用8.9MB，优化后数量仅343个，占用5.1MB。两者的数量差值为289，可以说明当前只渲染11个卡片，符合预期。</p>
<p>然而这点差别相对来说还OK，因为我直接用了线上的图片300张，每张只有20KB左右。主要还是解决了CPU占用过高的问题，而回收DOM带来的内存优化算是赠送的吧。</p>
<h2 id="其他问题"><a href="#其他问题" class="headerlink" title="其他问题"></a>其他问题</h2><h3 id="判断Wi-Fi导致卡顿"><a href="#判断Wi-Fi导致卡顿" class="headerlink" title="判断Wi-Fi导致卡顿"></a>判断Wi-Fi导致卡顿</h3><p>在较为古老的OPPO手机上测试该页面，发现还是有些卡顿，尝试把getNetworkType调用干掉，就继续丝滑了。</p>
<p>原因是每加载一个有视频的卡片时，我都会去判断一下网络类型，以应对用户切换Wi-Fi到4G之类的操作。因为APP的桥没有提供相应的监听函数，只好这样操作。但显然，不是很值得。</p>
<p>于是找到了一个<a href="https://developer.mozilla.org/zh-CN/docs/Web/API/NavigatorOnLine/Online_and_offline_events" target="_blank" rel="noopener">在线和离线事件</a>，可以监听浏览器上线和下线。如果用户从Wi-Fi切换到4G时会经历下线和上线，那真是完美了。当然，没有这么完美，切换网络过程中并没有触发这两个事件……</p>
<p>最终的解决方案是，每10秒调用一次getNetworkType，用轮询折衷一下。</p>
<h3 id="静音播放Bug"><a href="#静音播放Bug" class="headerlink" title="静音播放Bug"></a>静音播放Bug</h3><p>静音播放视频似乎没有问题，但是当我点进一个详情页，打开新的webview，再返回到当前页面时，诡异的播出了声音…… 并且，还没有找到原因。</p>
<h2 id="结果不做了"><a href="#结果不做了" class="headerlink" title="结果不做了"></a>结果不做了</h2><p>然后发现点评APP首页用的是WebP格式的动图，而不是视频。。。</p>
<p>改方案。。。</p>
<p>改接口。。。</p>
<p>优化基本是白写了，或者说，可以优化，但没必要。。。</p>
<p>（还是学到了点东西的）</p>
<h2 id="最后的结局"><a href="#最后的结局" class="headerlink" title="最后的结局"></a>最后的结局</h2><p>平台对WebP支持的稀烂，动图直接没处理，暂时无法支持动图……</p>
<p>所以还是要使用视频。</p>
<p>好消息是这个优化没白做，坏消息是我必须要解决静音变成非静音的bug。</p>
<p><strong>直接提了工单给平台，得知是对方手滑实现的“特性”，目前可以通过监听webview appear事件手动再设置一下muted即可。</strong></p>
<p>这…算是happy ending吧。</p>
</div><iframe src="/donate/?AliPayQR=/img/AliPayQR.jpg&amp;WeChatQR=/img/WeChatQR.jpg&amp;GitHub=null&amp;BTCQR=null&amp;BTCKEY=null&amp;PayPal=null" style="overflow-x:hidden; overflow-y:hidden; border:0xp none #fff; min-height:240px; width:100%;" frameborder="0" scrolling="no"></iframe><div class="tags"></div><div class="post-nav"><a class="pre" href="/2019/07/03/51/">从z-index到层叠上下文</a><a class="next" href="/2018/12/25/49/">图片预加载踩坑</a></div><div id="vcomment"></div><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="//unpkg.com/valine@latest/dist/Valine.min.js"></script><script>var notify = 'false' == true ? true : false;
var verify = 'false' == true ? true : false;
var GUEST_INFO = ['nick','mail','link'];
var guest_info = 'nick,mail'.split(',').filter(function(item){
  return GUEST_INFO.indexOf(item) > -1
});
guest_info = guest_info.length == 0 ? GUEST_INFO :guest_info;
window.valine = new Valine({
  el:'#vcomment',
  notify:notify,
  verify:verify,
  appId:'GdYXc7NL6OjXbEsEJpbupajS-gzGzoHsz',
  appKey:'V1O9dvhLxl0T3bC1aVN9TrUC',
  placeholder:'坐下说坐下说...',
  avatar:'mm',
  guest_info:guest_info,
  pageSize:'10'
})</script></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="http://www.pujiaxun.com"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/tech/">技术</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/life/">生活</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/Git/" style="font-size: 15px;">Git</a> <a href="/tags/JavaScript/" style="font-size: 15px;">JavaScript</a> <a href="/tags/Ruby/" style="font-size: 15px;">Ruby</a> <a href="/tags/English/" style="font-size: 15px;">English</a> <a href="/tags/面试/" style="font-size: 15px;">面试</a> <a href="/tags/爬虫/" style="font-size: 15px;">爬虫</a> <a href="/tags/实习/" style="font-size: 15px;">实习</a> <a href="/tags/Web/" style="font-size: 15px;">Web</a> <a href="/tags/macOS/" style="font-size: 15px;">macOS</a> <a href="/tags/闲谈/" style="font-size: 15px;">闲谈</a> <a href="/tags/LaTeX/" style="font-size: 15px;">LaTeX</a> <a href="/tags/算法/" style="font-size: 15px;">算法</a> <a href="/tags/python/" style="font-size: 15px;">python</a> <a href="/tags/效率/" style="font-size: 15px;">效率</a> <a href="/tags/生活/" style="font-size: 15px;">生活</a> <a href="/tags/经济学/" style="font-size: 15px;">经济学</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2019/07/03/51/">从z-index到层叠上下文</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/12/28/50/">图片视频瀑布流长列表性能优化实践</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/12/25/49/">图片预加载踩坑</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/10/25/48/">Webpack热更新内存泄漏探索</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/02/09/47/">Chrome中sticky定位的导航栏产生1px缝隙</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/01/18/46/">我是如何提高生存效率的</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/11/10/45/">Neo4j & Python 构建中国行政区划图</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/13/43/">快速排序算法原来这么简单</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/01/42/">macOS 中文输入法时 VS Code 快捷键失效</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/08/25/41/">如何区别真假网址？</a></li></ul></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2019 <a href="/." rel="nofollow">Pujiaxun的空间.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.1.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.2.5/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.1.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.2.5/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.1.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.1.0"></script></div></body></html>